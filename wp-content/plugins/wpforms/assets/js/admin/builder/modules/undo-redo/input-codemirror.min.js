export default function(e,o,r){class t extends WPForms.Admin.Builder.UndoRedoInputCommandBase.get(){static id="CodeMirrorChangeCommand";constructor(e,o,t,n="",d=""){super(e,n,d),this.editorId=o,this.editor=t}applyValue(o){if(this.editor){i.preventRecordingCommand=!0;let e=i.WPFormsCalculationsBuilder?.getEditorInstance(this.inputId);var t;e||(t=this.getElement(),i.WPFormsCalculationsBuilder?.setupSingleEditor(t,!0),e=i.WPFormsCalculationsBuilder?.getEditorInstance(this.inputId)),e&&(e.codemirror.setValue(o),e.codemirror.save()),i.preventRecordingCommand=!1}}}let i={el:{},sel:{insertFieldButton:".button-insert-field",aiCalcButton:".wpforms-ai-calculations-button:not(.education-modal)"},trackedEditors:new Map,init(){i.setup(),i.el.$builder.on("wpformsBuilderReady",_.debounce(i.ready,250)).on("wpformsCalculationsEditorReady",i.editorEvents)},setup(){i.el.$document=r(e),i.el.$builder=r("#wpforms-builder")},ready(){try{i.WPFormsCalculationsBuilder=WPFormsCalculationsBuilder}catch(e){return}try{i.UndoRedo=WPForms.Admin.Builder.UndoRedo,i.UndoRedoHelpers=WPForms.Admin.Builder.UndoRedoHelpers,i.undoManager=i.UndoRedo.undoManager,i.el={...i.el,...i.UndoRedo.el}}catch(e){return void wpf.debug("UndoRedoInputCodeMirror: Dependency modules are not available.")}i.UndoRedo.registerCommand(t),i.events()},events(){i.el.$builder.on("click",i.sel.insertFieldButton,i.onClickInsertField).on("click",i.sel.aiCalcButton,i.onClickAiCalculationsButton),i.el.$document.on("wpformsUndoRedoRun",i.undoRedoRun).on("wpformsAiCalculationsFormulaInserted",i.onFormulaInserted).on("wpformsDropdownListSelect",i.onDropDownListSelect)},editorEvents(e,o){o?.codemirror?.on&&(o.codemirror.on("focus",i.onEditorFocus),o.codemirror.on("blur",i.onEditorBlur))},onEditorFocus(e){var o=r(e.getTextArea()),o=i.UndoRedoHelpers.getElementKey(o);i.UndoRedo.trackedInputs.set(o,e.getValue())},onEditorBlur(e){var o,t,n,d;i.UndoRedo.isSuppressed()||i.preventRecordingCommand||(d=r(e.getTextArea()),o=i.UndoRedoHelpers.getElementKey(d),t=i.UndoRedo.trackedInputs.get(o),n=e.getValue(),i.UndoRedoHelpers.areValuesEqual(t,n))||(d=i.UndoRedo.getCommand("CodeMirrorChangeCommand",d,o,e,t,n),i.UndoRedo.record(d))},onClickInsertField(){var e=r(this).closest(".wpforms-field-option-row-calculation_code").data("field-id"),e=i.getCodeMirrorInstance(e);e&&i.onEditorFocus(e)},onClickAiCalculationsButton(){var e=r(this).data("field-id"),e=i.getCodeMirrorInstance(e);e&&i.onEditorFocus(e)},onFormulaInserted(e){var e=e.originalEvent.detail.fieldId;e&&(e=i.getCodeMirrorInstance(e))&&i.onEditorBlur(e)},onDropDownListSelect(e){var e=r(e.target).closest(".wpforms-field-option-row-calculation_code");e.length&&(e=e.data("field-id"),e=i.getCodeMirrorInstance(e))&&i.onEditorBlur(e)},undoRedoRun(e,o,t){["ActionFieldAddCommand","ActionFieldDuplicateCommand","ActionFieldDeleteCommand","ActionFieldMoveCommand","ActionMultiFieldDeleteCommand","ActionMultiFieldDuplicateCommand","ActionMultiFieldPasteCommand","ToggleChangeCommand"].includes(t.constructor?.id)&&i.WPFormsCalculationsBuilder&&("ToggleChangeCommand"===t.constructor?.id?(t=i.UndoRedoHelpers.getElement(t.$input)?.closest(".wpforms-field-option-row-calculation_is_enabled").data("field-id"),i.reInitSingleEditor(t)):r("#wpforms-field-options .wpforms-field-option-row-calculation_code").each(function(){i.reInitSingleEditor(r(this).data("field-id"))}))},reInitSingleEditor(e){i.WPFormsCalculationsBuilder?.removeEditorInstance?.(`wpforms-field-option-${e}-calculation_code`),i.WPFormsCalculationsBuilder?.initDuplicatedFieldCodeEditor?.(e)},getCodeMirrorInstance(e){return i.WPFormsCalculationsBuilder?.getEditorInstance?.(`wpforms-field-option-${e}-calculation_code`)?.codemirror??null}};return i}