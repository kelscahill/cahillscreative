export default function(e,t,n){let p={el:{},init(){p.setup(),p.el.$builder.on("wpformsBuilderReady",p.ready)},ready(){try{p.MultiSelect=WPForms.Admin.Builder.MultiSelect,p.MultiSelectActions=WPForms.Admin.Builder.MultiSelectActions,p.KeyboardShortcuts=WPForms.Admin.Builder.KeyboardShortcuts,p.WPFormsBuilder=WPFormsBuilder,p.FieldLayout=WPForms.Admin.Builder.FieldLayout,p.WPFormsChoicesJS=WPForms.Admin.Builder.WPFormsChoicesJS}catch(e){return void wpf.debug("CopyPaste: Dependency modules are not available.")}var e=WPFormsBuilder.getElementsCache();p.el={...p.el,...e?.elements},p.events()},setup(){p.el.$builder=n("#wpforms-builder"),p.el.$fieldsPanel=p.el.$builder.find(".wpforms-panel-fields")},events(){p.el.$document.on("keydown",p.onKeydown)},onKeydown(e){p.KeyboardShortcuts.pressMetaKey(e)&&!p.KeyboardShortcuts.isUserTypingInField()&&!p.isUserSelectedText()&&p.isFieldsPanelActive()&&("KeyC"===(e=e.originalEvent||e).code?p.copySelectedFieldsToClipboard():"KeyV"===e.code&&p.pasteFieldsFromClipboard())},isUserSelectedText(){return 0<p.el.$builder[0].ownerDocument.getSelection().toString().length},copySelectedFieldsToClipboard(){var e=p.getSelectedFields();if(0!==e.length){var t={fieldsData:p.getFieldsData(e),fieldIds:e},t=JSON.stringify(t,null,2);try{localStorage.setItem("wpforms_copied_fields",t),p.showCopyToast(e.length)}catch(e){console.error("Copy/Paste: Failed to store copied fields in localStorage:",e)}}},getFieldsData(e){let l={};return e.forEach(e=>{var t=p.getFieldDataWithHTML(e);t&&(l[e]=t,["layout","repeater"].includes(t.type))&&(l=p.addNestedFieldsToFieldsData(e,l))}),l},addNestedFieldsToFieldsData(e,l){var i=l[e].fieldSettings["columns-json"];if(i?.length){let t=[];i.forEach(e=>{e.fields?.length&&(t=t.concat(e.fields))}),(l={...l,...p.getFieldsData(t)})[e].nestedFieldIds=t}return l},showCopyToast(e){n(".wpforms-copy-toast").remove();var t=p.KeyboardShortcuts.getMetaKeyName(),e=1===e?wpforms_builder.multi_select.copy_toast_single.replace("%1$s",t):wpforms_builder.multi_select.copy_toast_multiple.replace("%1$d",e).replace("%2$s",t);let l=n(`
				<div class="wpforms-copy-toast">
					<div class="wpforms-copy-toast-content">
						<i class="fa fa-check-circle"></i>
						<span>${e}</span>
					</div>
				</div>
			`);p.el.$builder.append(l),setTimeout(()=>{l.addClass("wpforms-copy-toast-visible")},10),setTimeout(()=>{l.removeClass("wpforms-copy-toast-visible"),setTimeout(()=>{l.remove()},300)},3e3)},getFieldDataWithHTML(e){var t=n("#wpforms-field-"+e),l=n("#wpforms-field-option-"+e);return 0===t.length||0===l.length?null:{type:t.data("field-type"),id:e,fieldSettings:wpf.getField(e),fieldPreviewHTML:p.getFieldPreviewHTML(t),fieldOptionsHTML:p.getFieldOptionsHTML(l)}},getFieldPreviewHTML(e){var t,l,i=e.data("field-type");return"layout"===i||"repeater"===i?p.getLayoutFieldHTMLWithoutNestedFields(e):(i=p.WPFormsBuilder?.dropdownField,t=e.data("field-id"),(l=i?.helpers.isModernSelect(e.find("> .choices .primary-input")))&&i?.helpers.convertModernToClassic(t),e=e[0].outerHTML,l&&i?.helpers.convertClassicToModern(t),e)},getFieldOptionsHTML(e){return p.replaceChoicesJSWithOriginalSelect(e.clone(!0))[0].outerHTML},replaceChoicesJSWithOriginalSelect(r){return r.find("select.choices__input").each(function(){var t=n(this),i=p.WPFormsChoicesJS?.getRegistryData(t),d=i?.element;if(d){let l=n(d);d=t.attr("id");let e=(t.data("choicesjs")||i?.instance)?.getValue();Array.isArray(e)||(e=e?[e]:[]),l.val(e.map(e=>e.value)),l.find("option").removeAttr("selected"),e.forEach(function(e){let t=l.find(`option[value="${e.value}"]`);t.length||(t=n("<option>",{value:e.value,text:e.label}),l.append(t)),t.prop("selected",!0).attr("selected","selected").text((e,t)=>t.trim())}),r.find(`select[data-choicesjs-key="${i.key}"], select[id="${d}"]`).closest(".choices").replaceWith(l)}}),r},getLayoutFieldHTMLWithoutNestedFields(e){e=e.clone();return e.find(".wpforms-layout-column").each(function(){n(this).find(".wpforms-field:not(.wpforms-layout-column-placeholder)").remove()}),e.find(".wpforms-repeater-block").each(function(){n(this).find(".wpforms-field:not(.wpforms-repeater-placeholder)").remove()}),e[0].outerHTML},pasteFieldsFromClipboard(){let e;try{var t=localStorage.getItem("wpforms_copied_fields");if(!t)return;e=JSON.parse(t)}catch(e){return void console.error("Failed to read stored fields data:",e)}p.validateFieldsData(e)&&p.pasteFields(e)},validateFieldsData(e){var t,l=e?.fieldsData,e=e?.fieldIds;if(!Array.isArray(e)||0===e.length||"object"!=typeof l||null===l)return!1;for(t in l){var i=l[t];if(!("object"==typeof i&&i.type&&i.id&&i.fieldPreviewHTML&&i.fieldOptionsHTML))return!1}return!0},async pasteFields(e){var t=(p.pasteData=e).fieldIds,e=e.fieldsData,l=p.getNextFieldId(),i=p.MultiSelectActions?.getDuplicatePosition(),e=(p.el.$builder.trigger("wpformsBeforeMultiFieldPaste",[t,e,i]),WPForms.Admin.Builder.UndoRedo?.preventRecord(!0),await p.pasteFieldsInSequence(e,t,l,i,null));p.allFieldsPasted(e)},async pasteFieldsInSequence(t,l,e,i,d=null){var r=[];let a=e;for(let e=0;e<l.length;e++){var s=l[e],o=t[s];if(p.MultiSelect?.isDuplicationAllowed(s,o.type)){a++;try{await p.pasteFieldFromHTML(o,a,i,d),r.push(a),i=a,["layout","repeater"].includes(o.fieldSettings.type)&&(a=await p.pasteNestedFields(o,a)),p.updateNextFieldId(a)}catch(e){wpf.debug("CopyPaste: Failed to paste field.",e,o)}}}return r},async pasteNestedFields(e,t){var l=e.fieldSettings["columns-json"],i=p.pasteData.fieldsData;if(!l?.length)return t;let d=t+1,r=t;var a=JSON.parse(JSON.stringify(l));for(let e=0;e<l.length;e++){var s,o=l[e];o.fields?.length?(s=n(`#wpforms-field-${t} .wpforms-layout-column`).eq(e),o=await p.pasteFieldsInSequence(i,o.fields,d,r,s),a[e].fields=o,r=o[o.length-1],d=p.getNextFieldId()):a[e].fields=[]}return p.FieldLayout?.updateFieldColumnsData(t,a),p.FieldLayout?.reorderLayoutFieldsOptions(n("#wpforms-field-"+t)),d},allFieldsPasted(e){WPFormsBuilder.increaseNextFieldIdAjaxRequest?.(),p.clearAllSelections(),p.selectPastedFields(e),WPForms.Admin.Builder.UndoRedo?.preventRecord("continue"),p.el.$builder.trigger("wpformsMultiFieldPasted",[e])},clearAllSelections(){n("#wpforms-panel-fields .wpforms-field").removeClass("selected").removeClass("first-selected").removeClass("active"),p.MultiSelect?.clearMultiSelections()},selectPastedFields(e){1===e.length?n("#wpforms-field-"+e[0]).addClass("active"):e.forEach((e,t)=>{e=n("#wpforms-field-"+e);e.addClass("selected"),0===t&&e.addClass("active first-selected")}),0<e.length&&WPFormsBuilder.fieldTabToggle(e[0])},getNextFieldId(){var e=n("#wpforms-field-id");if(e.length)return Number.parseInt(e.val(),10);let t=0;return n(".wpforms-field").each(function(){var e=n(this).data("field-id");e&&e>t&&(t=e)}),t+1},pasteFieldFromHTML(r,a,s=null,o=null){return new Promise((e,t)=>{try{var l=p.prepareFieldHTML(r,a,!0),i=p.prepareFieldHTML(r,a,!1),d=p.MultiSelectActions?.getDuplicatePosition(s,r.type);p.el.$builder.trigger("wpformsBeforeFieldPaste",[a,r]),p.addFieldPreview(l,d,o),p.addFieldOptions(i,d,o),p.initializePastedField(a,r),p.el.$builder.trigger("wpformsFieldPasted",[a]),e(a)}catch(e){t(e)}})},prepareFieldHTML(e,t,l=!0){let i=l?e.fieldPreviewHTML:e.fieldOptionsHTML;var d=e.id,d=(i=(i=t.toString().includes(d.toString())?i:i.replace(new RegExp("wpforms-field-"+d,"g"),"wpforms-field-"+t)).replace(new RegExp(`data-field-id="${d}"`,"g"),`data-field-id="${t}"`).replace(new RegExp(`fields\\[${d}\\]`,"g"),`fields[${t}]`).replace(new RegExp("ID #"+d,"g"),"ID #"+t).replace(new RegExp(`data-reference="${d}"`,"g"),`data-reference="${t}"`).replace(new RegExp(`value="${d}"`,"g"),`value="${t}"`).replace(new RegExp(`\\b(id|for)="wpforms-(.*?)${d}(.*?)"`,"ig"),`$1="wpforms-$2${t}$3"`),n("<div>").html(i));return d.find(l?".active, .selected":".selected").removeClass("active").removeClass("selected"),l?p.updateFieldPreview(d,e):p.updateFieldSettings(d,e),d.html()},getFieldLabel(e){var t=e.fieldSettings.label??e.fieldSettings.name??"";return WPFormsBuilder.getDuplicatedFieldLabel(t,e.id)},updateFieldPreview(e,t){let d=n("#wpforms-field-"+t.id).find("input, select, textarea");e.find("> .wpforms-field").removeClass("label_empty").find(".label-title span.text").text(p.getFieldLabel(t)),e.find("input, select, textarea").each(function(e){var t=n(this),e=d.eq(e),l=t.attr("type");let i;i="checkbox"===l||"radio"===l?e.is(":checked"):e.val(),p.updateFieldSettingInput(t,i)})},updateFieldSettings(e,t){var l,i,e=e.find(".wpforms-field-option");e.length&&(i=t.fieldSettings,l=`fields[${e.data("field-id")}]`,(i={...i}).label=i.label?p.getFieldLabel(t):null,i.name=i.name?p.getFieldLabel(t):null,delete i.id,delete i.type,e.find('input[type="radio"][name*="[default]"], input[type="checkbox"][name*="[default]"]').attr("checked",!1),p.FieldLayout?.isLayoutBasedField(t.fieldSettings.type)&&e.find('input[name*="[columns-json]"]').attr("value","[]"),p.updateFieldInputs(e,i,l),e.find(".CodeMirror").remove(),e.find("textarea.wpforms-codemirror-editor").css("display",""))},updateFieldInputs(l,i,d){i&&Object.keys(i).forEach(e=>{var t=d+`[${e}]`,e=i[e];"object"==typeof e&&null!==e?p.updateFieldInputs(l,e,t):(t=l.find(`[name="${CSS.escape(t)}"]`),p.updateFieldSettingInput(t,e))})},updateFieldSettingInput(e,t){var l;e.length&&("radio"===(l=e.attr("type"))?e.filter(`[value="${t}"]`).attr("checked",!0):"checkbox"===l?e.attr("checked","1"===t||1===t||!0===t):e.is("select")?p.updateFieldSelectElement(e,t):(e.val(t),e.is("textarea")?e.text(t):e.attr("value",t)))},updateFieldSelectElement(t,e){t?.length&&null!==e&&(t.find("option").removeAttr("selected"),(e=Array.isArray(e)?e:[e]).forEach(e=>{t.find(`option[value="${e}"]`).attr("selected",!0)}))},addFieldPreview(e,t=null,l=null){e=n("<div>").html(e).find(".wpforms-field");e.length&&(e[0].style.marginBottom=null,l?.length?l.append(e):(l=n("#wpforms-field-"+t)).length?l.after(e):n("#wpforms-panel-fields .wpforms-field-wrap").append(e))},isFieldInsideLayoutOrRepeater(e){var e=e.closest(".wpforms-layout-column");return!(!e.length||!(e=e.closest(".wpforms-field")).length||"layout"!==(e=e.data("field-type"))&&"repeater"!==e)},addFieldOptions(t,l=null,i=null){t=n("<div>").html(t).find(".wpforms-field-option");if(t.length)if(i?.length){i=i.closest(".wpforms-field").data("field-id");let e=n("#wpforms-field-option-"+i);void(e.length&&e.after(t))}else{let e=n("#wpforms-field-option-"+l);e.length?e.after(t):n("#wpforms-field-options").append(t)}},initializePastedField(e,t){p.removeNoFieldsPlaceholder(),p.initializeFieldOptions(e),p.initializeFieldPreview(e,t),p.initializeFieldInContainerField(e),p.el.$builder.trigger("wpformsFieldAdd",[e,t.type,{}])},initializeFieldOptions(e){e=n("#wpforms-field-option-"+e);0!==e.length&&(WPFormsBuilder?.loadColorPickers?.(e),wpf.initTooltips(e))},initializeFieldPreview(e,t){0!==n("#wpforms-field-"+e).length&&"select"===t.type&&"modern"===t.fieldSettings.style&&p.WPFormsBuilder?.dropdownField.helpers.convertClassicToModern(e)},initializeFieldInContainerField(e){var t=n("#wpforms-field-"+e),l=n("#wpforms-field-option-"+e);0!==t.length&&0!==l.length&&(l=t.closest(".wpforms-layout-column")).length&&(t=t.index()-1,p.FieldLayout?.positionFieldInColumn(e,t,l))},removeNoFieldsPlaceholder(){p.el.$builder.find(".no-fields, .no-fields-preview").remove(),n(".wpforms-field-option:not(.wpforms-field-option-layout)").length&&p.el.$builder.find(".wpforms-field-submit").show()},updateNextFieldId(e){var t=n("#wpforms-field-id");t.length&&t.val(e+1)},getSelectedFields(){return p.MultiSelect?.getSelectedFields?.()??[]},isFieldsPanelActive(){return p.el.$fieldsPanel.hasClass("active")}};return p}