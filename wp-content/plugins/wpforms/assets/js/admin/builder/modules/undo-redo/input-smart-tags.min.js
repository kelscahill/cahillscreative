export default function(e,t,d){class a extends WPForms.Admin.Builder.UndoRedoInputCommandBase.get(){static id="SmartTagWidgetChangeCommand";constructor(e,t,a,o){super(e,t,a),this.$widget=e,this.args=o,this.$originalInput=s.getOriginalInput(e)}applyValue(e){var t=this.getElement(this.$originalInput);t?.length&&(s.UndoRedo.preventRecord(!0),t.attr("value",e).val(e).trigger("input").trigger("wpformsSmartTagsInputSync"),(e=t.closest(".wpforms-field-map-custom-wrap")).length&&"close-custom-value"===this.args?.event&&(t=e.prev("select.wpforms-field-map-select"),e.is(":visible")?e.find(".wpforms-field-map-custom-value-close").trigger("click"):t.val("custom_value").trigger("change")),s.UndoRedo.preventRecord("continue"))}}let s={el:{},sel:{smartTagWidget:".wpforms-smart-tags-widget"},undoManager:null,trackedWidgets:new Map,lastRecordedWidgetState:new WeakMap,init(){s.setup(),s.el.$builder.on("wpformsBuilderReady",_.debounce(s.ready,250))},setup(){s.el.$document=d(e),s.el.$builder=d("#wpforms-builder")},ready(){try{s.UndoRedo=WPForms.Admin.Builder.UndoRedo,s.UndoRedoHelpers=WPForms.Admin.Builder.UndoRedoHelpers,s.undoManager=s.UndoRedo.undoManager,s.actionNameSeparator=s.UndoRedo.config.actionNameSeparator,s.el={...s.el,...s.UndoRedo.el}}catch(e){return void wpf.debug("UndoRedoInputSmartTags: Dependency modules are not available.")}s.UndoRedo.registerCommand(a),s.events()},events(){s.el.$document.on("focus",s.sel.smartTagWidget,s.onSmartTagsWidgetFocus).on("blur",s.sel.smartTagWidget,s.onSmartTagsWidgetBlur).on("mousedown",".wpforms-field-map-custom-value-close",s.onCustomValueCloseMousedown).on("click",".wpforms-field-map-custom-value-close",s.onCustomValueCloseClick)},onSmartTagsWidgetFocus(e){var e=d(e.target),t=s.getSmartTagsWidgetKey(e);s.trackedWidgets.set(t,{htmlContent:e.html(),inputValue:s.getOriginalInput(e).val()})},onSmartTagsWidgetBlur(e){var t,a,o,r=d(e.target),n=s.getSmartTagsWidgetKey(r),n=s.trackedWidgets.get(n);!n||(t=r.html()).includes('<span class="tag" contenteditable="true" data-value="')||(a=s.getOriginalInput(r).val(),o=s.lastRecordedWidgetState.get(r[0]),n.htmlContent===t)||o&&o===t||s.recordSmartTagsWidgetChange(r,n.htmlContent,t,n.inputValue,a,{event:e.customType??e.type})},onCustomValueCloseMousedown(e){var t=s.getCustomValueWidget(d(e.target));e.target=t[0],s.onSmartTagsWidgetFocus(e)},onCustomValueCloseClick(e){var t;s.UndoRedo.isRecordPrevented()||(t=s.getCustomValueWidget(d(e.target)),e.target=t[0],e.customType="close-custom-value",s.onSmartTagsWidgetBlur(e))},getCustomValueWidget(e){return e.closest(".wpforms-field-map-custom-wrap").find(s.sel.smartTagWidget)},recordSmartTagsWidgetChange(e,t,a,o,r,n){s.UndoRedo.isRecordPrevented()||(o=s.UndoRedo.getCommand("SmartTagWidgetChangeCommand",e,o,r,n),s.UndoRedo.record(o),s.lastRecordedWidgetState.set(e[0],a))},recordSmartTagImmediate(t){if(!s.UndoRedo.isRecordPrevented()){var a=s.getSmartTagsWidgetKey(t);let e=s.trackedWidgets.get(a);e||(r=s.lastRecordedWidgetState.get(t[0]),e={htmlContent:r||"",inputValue:s.getOriginalInput(t).val()});var o,r=t.html();e.htmlContent!==r&&(o=s.getOriginalInput(t).val(),s.recordSmartTagsWidgetChange(t,e.htmlContent,r,e.inputValue,o,{event:"immediate"}),s.trackedWidgets.set(a,{htmlContent:r,inputValue:o}))}},getOriginalInput(e){return e.parent().next(".wpforms-smart-tags-widget-original")},getSmartTagsWidgetKey(e){e=s.getOriginalInput(e);return s.UndoRedoHelpers.getElementKey(e)}};return s}