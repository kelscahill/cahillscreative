var WPForms=window.WPForms||{};WPForms.Admin=WPForms.Admin||{},WPForms.Admin.Builder=WPForms.Admin.Builder||{},WPForms.Admin.Builder.Providers=WPForms.Admin.Builder.Providers||((e,p)=>{let f={hasUnsavedNewConnection:!1,cache:{},config:{templates:["wpforms-providers-builder-content-connection-fields","wpforms-providers-builder-content-connection-conditionals"]},fields:{}},u={panelHolder:{},form:p("#wpforms-builder-form"),spinner:'<i class="wpforms-loading-spinner wpforms-loading-inline"></i>',ajax:{_mergeData(e,r){e={id:u.form.data("id"),revision_id:u.form.data("revision"),nonce:wpforms_builder.nonce,action:"wpforms_builder_provider_ajax_"+e};return p.extend(e,r),e},request(n,e){let t=u.getProviderHolder(n),i=t.find(".wpforms-builder-provider-connections-save-lock");var r={url:wpforms_builder.ajax_url,type:"post",dataType:"json",beforeSend(){t.addClass("loading"),i.val(1),u.ui.getProviderError(n).hide()}};return"connections_get"!==e.data.task&&t.find(".wpforms-builder-provider-title-spinner").removeClass("wpforms-hidden"),e.data=u.ajax._mergeData(n,e.data||{}),p.extend(r,e),p.ajax(r).fail(function(e,r,o){console.error("provider:",n),console.error(e),console.error(r),i.val(1),u.ui.showError(n)}).always(function(e,r,o){t.removeClass("loading"),"success"===r&&i.val(0)})}},cache:{get(e,r){return void 0!==f.cache[e]&&f.cache[e]instanceof Map?f.cache[e].get(r):null},getById(e,r,o){return void 0===this.get(e,r)||void 0===this.get(e,r)[o]?null:this.get(e,r)[o]},set(e,r,o){return void 0!==f.cache[e]&&f.cache[e]instanceof Map||(f.cache[e]=new Map),f.cache[e].set(r,o)},addTo(e,r,o,n){void 0!==f.cache[e]&&f.cache[e]instanceof Map||(f.cache[e]=new Map,this.set(e,r,{}));var t=this.get(e,r);return t[o]=n,this.set(e,r,t)},delete(e,r){return void 0!==f.cache[e]&&f.cache[e]instanceof Map?f.cache[e].delete(r):null},deleteFrom(e,r,o){var n;return void 0!==f.cache[e]&&f.cache[e]instanceof Map?(delete(n=this.get(e,r))[o],this.set(e,r,n)):null},clear(e){void 0!==f.cache[e]&&f.cache[e]instanceof Map&&f.cache[e].clear()}},init(){p(u.ready)},ready(){f.fields=p.extend({},wpf.getFields(!1,!0)),u.panelHolder=p("#wpforms-panel-providers, #wpforms-panel-settings"),u.Templates=WPForms.Admin.Builder.Templates,u.Templates.add(f.config.templates),u.bindActions(),u.ui.bindActions(),u.panelHolder.trigger("WPForms.Admin.Builder.Providers.ready")},bindActions(){p(e).on("wpformsSaved",function(){f.hasUnsavedNewConnection=!1;var e=u.panelHolder.find(".wpforms-builder-provider-connection");if(e.length){let n=!1;e.each(function(){let o=!1;var e,r;p(this).find("input.wpforms-required, select.wpforms-required, textarea.wpforms-required").each(function(){var e=p(this),r=e.val();_.isEmpty(r)&&!e.closest(".wpforms-builder-provider-connection-block").hasClass("wpforms-hidden")?(p(this).addClass("wpforms-error"),o=!0):p(this).removeClass("wpforms-error")}),o&&!n&&((e=p(this).closest(".wpforms-builder-provider").find(".wpforms-builder-provider-title").clone()).find("button").remove(),r=wpforms_builder.provider_required_flds,p.alert({title:wpforms_builder.heads_up,content:r.replace("{provider}","<strong>"+e.text().trim()+"</strong>"),icon:"fa fa-exclamation-circle",type:"red",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"]}}}),n=!0)}),"fields"===wpf.getQueryString("view")&&u.updateMapSelects(e)}}),p(e).on("wpformsFieldUpdate",function(){var e=u.panelHolder.find(".wpforms-builder-provider-connection");u.updateMapSelects(e)}),u.panelHolder.on("connectionCreate",function(){f.hasUnsavedNewConnection=!0}),u.panelHolder.on("connectionGeneralSettingsRendered connectionRendered",function(e,n){"string"!=typeof n||f.hasUnsavedNewConnection||setTimeout(()=>{var e,r,o=wpf._getCurrentFormState();for([e,r]of Object.entries(o))new RegExp(`\\[?${n}[\\[\\]]`).test(e)&&void 0===wpf.savedFormState[e]&&(wpf.savedFormState[e]=r)},0)})},updateMapSelects(o){var e=p.extend({},wpf.getFields()),n=_.mapObject(e,function(e,r){return e.label}),t=_.mapObject(f.fields,function(e,r){return e.label});if(!(_.isEmpty(n)&&_.isEmpty(t)||JSON.stringify(n)===JSON.stringify(t))){let r=Object.keys(n).map(function(e){return parseInt(e,10)});var a,s=Object.keys(t).map(function(e){return parseInt(e,10)}).filter(function(e){return!r.includes(e)});for(let e=0;e<s.length;e++)p('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value="'+s[e]+'"]',o).remove();let i=[],d=[];for(a in e){let o=e[a];var l=o.id,c=o.type;let n=wpf.sanitizeHTML(o.label?.toString().trim()||wpforms_builder.field+" #"+l);i.push({value:l,text:n,type:c}),"name"===o.type&&o.format?p.each(wpforms_builder.name_field_formats,function(e,r){-1===o.format.indexOf(e)&&"full"!==e||d.push({value:o.id+"."+e,text:n+" ("+r+")"})}):d.push({value:l,text:n})}u.panelHolder.trigger("WPForms.Admin.Builder.Providers.FilterOptions",[i]),u.panelHolder.trigger("WPForms.Admin.Builder.Providers.FilterOptionsWithSubfields",[d]),p(".wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value").each(function(){var e=p(this);let r=e.val(),o=e.clone().empty();var n=e.data("support-subfields")||Boolean(e.find('option[value$=".first"]').length)?d:i,t=e.data("placeholder")&&e.data("placeholder").length?e.data("placeholder"):wpforms_builder_providers.custom_fields_placeholder;o.append(p("<option>",{value:"",text:t})),n.forEach(function(e){o.append(p("<option>",{value:e.value,text:e.text,selected:r.toString()===e.value.toString()}))}),e.replaceWith(o)}),f.fields=e,u.panelHolder.trigger("WPForms.Admin.Builder.Providers.updatedMapSelects",[o,e])}},ui:{bindActions(){u.panelHolder.on("click",".js-wpforms-builder-provider-account-add",function(e){e.preventDefault(),u.ui.account.setProvider(p(this).data("provider")),u.ui.account.add()}).on("click",".js-wpforms-builder-provider-connection-add",function(e){e.preventDefault(),u.ui.connectionAdd(p(this).data("provider"))}).on("click",".js-wpforms-builder-provider-connection-delete",function(e){var r=p(this);e.preventDefault(),u.ui.connectionDelete(r.closest(".wpforms-builder-provider").data("provider"),r.closest(".wpforms-builder-provider-connection"))}),u.panelHolder.on("click",".js-wpforms-builder-provider-connection-fields-add",function(e){e.preventDefault();var e=p(this).parents(".wpforms-builder-provider-connection-fields-table"),r=e.find("tr").last().clone(!0),o=parseInt(/\[.+]\[.+]\[.+]\[(\d+)]/.exec(r.find(".wpforms-builder-provider-connection-field-name").attr("name"))[1],10)+1;r.find(".wpforms-builder-provider-connection-field-name").attr("name",r.find(".wpforms-builder-provider-connection-field-name").attr("name").replace(/\[fields_meta\]\[(\d+)\]/g,"[fields_meta]["+o+"]")).val(""),r.find(".wpforms-builder-provider-connection-field-value").attr("name",r.find(".wpforms-builder-provider-connection-field-value").attr("name").replace(/\[fields_meta\]\[(\d+)\]/g,"[fields_meta]["+o+"]")).val(""),r.find(".js-wpforms-builder-provider-connection-fields-delete").removeClass("hidden"),e.find("tbody").append(r.get(0))}).on("click",".js-wpforms-builder-provider-connection-fields-delete",function(e){e.preventDefault(),p(this).parents(".wpforms-builder-provider-connection-fields-table tr").remove()}),u.panelHolder.on("connectionGenerated",function(e,r){wpf.initTooltips(),p(this).find('.wpforms-builder-provider-connection[data-connection_id="'+r.connection.id+'"]').closest(".wpforms-panel-content-section").find(".wpforms-builder-provider-connections-default").addClass("wpforms-hidden")}),u.panelHolder.on("connectionRendered",function(e,r,o){if(wpf.initTooltips(),void 0===o){if(!_.isObject(r)||!_.has(r,"connection_id"))return;o=r.connection_id}p(this).find('.wpforms-builder-provider-connection[data-connection_id="'+o+'"] .wpforms-field-map-select').length&&wpf.fieldUpdate()}),u.panelHolder.on("change",".wpforms-builder-provider select.wpforms-required",function(){var e=p(this);e.hasClass("wpforms-error")&&0!==e.val().length&&e.removeClass("wpforms-error")}),u.panelHolder.on("connectionDeleted",function(e){u.ui.updateStatus(e)})},connectionAdd(o){let r=u.ui.getDefaultConnectionName(o).trim();p.confirm({title:!1,content:wpforms_builder_providers.prompt_connection.replace(/%type%/g,"connection")+"<input "+(""===r?' autofocus=""':"")+'type="text" id="wpforms-builder-provider-connection-name" placeholder="'+wpforms_builder_providers.prompt_placeholder+'" value="'+r+'"><p class="error">'+wpforms_builder_providers.error_name+"</p>",icon:"fa fa-info-circle",type:"blue",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"],action(){var e=this.$content.find("#wpforms-builder-provider-connection-name").val().trim(),r=this.$content.find(".error");if(""===e)return r.show(),!1;u.getProviderHolder(o).trigger("connectionCreate",[e])}},cancel:{text:wpforms_builder.cancel}},onContentReady(){var e=this.$content.find("#wpforms-builder-provider-connection-name")[0];r&&(e.setSelectionRange(r.length,r.length),e.focus())}})},connectionDelete(r,o){p.confirm({title:!1,content:wpforms_builder_providers.confirm_connection,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"],action(){u.getProviderHolder(r).trigger("connectionDelete",[o]);let e=o.closest(".wpforms-panel-content-section");o.fadeOut("fast",function(){p(this).remove(),u.getProviderHolder(r).trigger("connectionDeleted",[o]),e.find(".wpforms-builder-provider-connection").length||e.find(".wpforms-builder-provider-connections-default").removeClass("wpforms-hidden")})}},cancel:{text:wpforms_builder.cancel}}})},getDefaultConnectionName(e){var r=u.getProviderHolder(e).data("provider-name"),e=u.ui.getCountConnectionsOf(e),r=r+" "+wpforms_builder.connection_label;return e<1?r:""},getCountConnectionsOf(e){return u.getProviderHolder(e).find(".wpforms-builder-provider-connection").length},updateStatus(e){var r=e.target.closest(".wpforms-panel-content-section");p(".wpforms-panel-sidebar-section-"+e.target.dataset.provider).find(".fa-check-circle-o").toggleClass("wpforms-hidden",p(r).find(".wpforms-builder-provider-connection").length<=0)},getProviderError(e){return p(`#wpforms-${e}-builder-provider-error`)},showError(e){var r,o=u.ui.getProviderError(e);(o.length?o:(o=`wpforms-${e}-builder-content-connection-default-error`,r=u.getProviderHolder(e).find(".wpforms-builder-provider-connections"),u.Templates.add([o]),r.prepend(u.Templates.get(o)()),u.ui.getProviderError(e))).show()},account:{provider:"",submitHandlers:[],setProvider(e){this.provider=e},add(){let n=this;p.confirm({title:!1,smoothContent:!0,content(){let r=this;return u.ajax.request(n.provider,{data:{task:"account_template_get"}}).done(function(e){e.success&&(e.data.title.length&&r.setTitle(e.data.title),e.data.content.length&&r.setContent(e.data.content),e.data.type.length&&r.setType(e.data.type),u.getProviderHolder(n.provider).trigger("accountAddModal.content.done",[r,n.provider,e]))}).fail(function(){u.getProviderHolder(n.provider).trigger("accountAddModal.content.fail",[r,n.provider])}).always(function(){u.getProviderHolder(n.provider).trigger("accountAddModal.content.always",[r,n.provider])})},contentLoaded(e,r,o){this.buttons.add.enable(),this.buttons.cancel.enable(),u.getProviderHolder(n.provider).trigger("accountAddModal.contentLoaded",[this])},onOpenBefore(){this.buttons.add.disable(),this.buttons.cancel.disable(),this.$body.addClass("wpforms-providers-account-add-modal"),u.getProviderHolder(n.provider).trigger("accountAddModal.onOpenBefore",[this])},onClose(){!0===u.ui.account.isConfigured(n.provider)&&u.ui.connectionAdd(n.provider)},icon:"fa fa-info-circle",type:"blue",buttons:{add:{text:wpforms_builder.provider_add_new_acc_btn,btnClass:"btn-confirm",keys:["enter"],action(){if(u.getProviderHolder(n.provider).trigger("accountAddModal.buttons.add.action.before",[this]),!_.isEmpty(n.provider)&&void 0!==n.submitHandlers[n.provider])return n.submitHandlers[n.provider](this)}},cancel:{text:wpforms_builder.cancel}}})},registerAddHandler(e,r){"string"==typeof e&&"function"==typeof r&&(this.submitHandlers[e]=r)},isConfigured(e){return u.getProviderHolder(e).find(".js-wpforms-builder-provider-account-add").hasClass("hidden")}}},getProviderHolder(e){return p("#"+e+"-provider")},getProviderClass(e){console.warn('WARNING! Function "WPForms.Admin.Builder.Providers.getProviderClass()" has been deprecated!');e=e.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join("");return void 0===WPForms.Admin.Builder.Providers[e]?null:WPForms.Admin.Builder.Providers[e]}};return u})(document,(window,jQuery)),WPForms.Admin.Builder.Providers.init();