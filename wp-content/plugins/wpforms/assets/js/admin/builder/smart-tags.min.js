var WPForms=window.WPForms||{};WPForms.Admin=WPForms.Admin||{},WPForms.Admin.Builder=WPForms.Admin.Builder||{},WPForms.Admin.Builder.SmartTags=WPForms.Admin.Builder.SmartTags||((g,m,p)=>{let t={},r=new WeakMap,c={init(){p(c.ready)},ready(){c.setup(),c.events()},setup(){t.$builder=p("#wpforms-builder")},events(){t.$builder.on("wpformsBuilderReady",()=>{c.initWidgets(t.$builder)}).on("wpformsBuilderReady",c.initDropdowns).on("connectionsDataLoaded",c.initWidgetsInConnections).on("connectionRendered",c.initWidgetsInConnections).on("wpformsSettingsBlockAdded wpformsSettingsBlockCloned ",c.reinitWidgetInClone).on("wpformsFieldAdd",c.fieldAdd).on("wpformsFieldDuplicated",c.fieldDuplicated).on("wpformsFieldPasted",c.fieldPasted).on("change",".wpforms-field-option-row-label input",c.fieldLabelChangeEvent),t.$builder.on("click",".wpforms-show-smart-tags, .mce-wpforms-smart-tags-mce-button",function(){c.showSmartTagDropdown(p(this))}),p(g).on("wpformsFieldUpdate",c.initDropdowns).on("click",".wpforms-smart-tags-widget .tag",c.smartTagClick)},initWidgets(e=t.$builder){e.find(".wpforms-smart-tags-enabled").each(function(){if(!p(this).hasClass("wpforms-smart-tags-widget-original")){let t=p(this),a=t.is("input")?"input":"textarea";var e="wpforms-smart-tags-widget-"+a,n=c.isNonEditableInput(t),i=n?"wpforms-readonly":"",s=p("<div>",{class:"wpforms-smart-tags-widget-container"});t.before(s);let r=p("<div>",{class:["wpforms-smart-tags-widget",e,i].filter(Boolean).join(" "),contenteditable:n?"false":"true",spellcheck:"false",text:t.val()});s.append(r),s.append('<span class="wpforms-show-smart-tags"><i class="fa fa-tags"></i></span>'),t.addClass("wpforms-smart-tags-widget-original"),c.setupOriginalInputObserver(t),t.on("wpformsSmartTagsInputSync",function(){c.syncWidgetContent(t,r)}),r.on("input",c.renderWidgetContent),r.on("focus blur keyup mouseup",function(){c.saveCaretPosition(r[0])}),r.on("focusout",function(){t.trigger("focusout")}),r.on("copy",function(e){c.copyWidgetContent(e,t)}),r.on("keydown",function(e){"input"==a&&"Enter"===e.key&&e.preventDefault(),"textarea"!=a||"Enter"!==e.key||e.shiftKey||(e.preventDefault(),c.insertLineBreak())}),r.data("pasteHandlerAttached")||(r.on("paste",e=>{var t;e.preventDefault(),r.hasClass("wpforms-readonly")||(t=g.defaultView.getSelection()).rangeCount&&(e=e.originalEvent.clipboardData.getData("text/plain"),(t=t.getRangeAt(0)).deleteContents(),t.insertNode(g.createTextNode(e)),t.collapse(!1),c.renderWidgetContent({target:r[0]},!0,"end"))}),r.data("pasteHandlerAttached",!0)),c.renderWidgetContent({target:r[0]},!0),WPFormsUtils.triggerEvent(r,"wpformsSmartTagWidgetInitialized"),c.initTooltip(r)}})},reinitWidgets(e){(e=e.hasClass("wpforms-smart-tags-widget-container")?e.parent():e).find(".wpforms-smart-tags-widget-container").each(c.destroyWidget),c.initWidgets(e)},destroyWidget(){var e=p(this),t=e.next(".wpforms-smart-tags-enabled");c.isNonEditableInput(t)||(t.removeClass("wpforms-smart-tags-widget-original"),e.remove())},isNonEditableInput(e){return e.prop("readonly")||e.prop("disabled")},reinitWidgetInClone(e,t){c.reinitWidgets(t)},initWidgetsInConnections(e){e=p(e.target);c.initWidgets(e)},renderWidgetContent(e,t=!1,a=""){let l=e.target;if(!l.classList.contains("tag")){l.normalize();e=g.defaultView.getSelection();if(e.rangeCount||t){var r=Array.from(l.childNodes);let d=null;r.forEach(a=>{if(a.nodeType===Node.TEXT_NODE){let e=a.nodeValue;for(var r=/{([^{}]+)}/g;null!==(o=r.exec(e));){var n=wpf.sanitizeHTML(o[1].trim()),i=o[0],s=c.handleEmailTag(i,n,o,e,a);if(s.handled)e=s.text,a=s.node;else{s=c.getSmartTagTitle(n);let t=g.createElement("span");t.classList.add("tag"),t.contentEditable="false",t.setAttribute("data-value",n),t.innerText=s;var n=g.createElement("i"),s=(n.classList.add("fa","fa-times-circle"),n.setAttribute("title",wpforms_builder.smart_tags_delete_button),n.addEventListener("click",e=>{e.stopPropagation(),t.remove(),c.updateOriginalInput(l),m.WPForms?.Admin?.Builder?.UndoRedoInputSmartTags?.recordSmartTagImmediate(p(l))}),t.appendChild(n),e.slice(0,o.index)),n=e.slice(o.index+i.length),o=g.createTextNode(s),i=g.createTextNode(n),s=a.parentNode;s.insertBefore(o,a),s.insertBefore(t,a),s.insertBefore(i,a),s.removeChild(a),e=n,a=i,d=t,r.lastIndex=0}}}}),d&&!t&&((r=g.createRange()).setStartAfter(d),r.collapse(!0),e.removeAllRanges(),e.addRange(r)),"end"===a&&((t=g.createRange()).selectNodeContents(l),t.collapse(!1),e.removeAllRanges(),e.addRange(t)),c.updateOriginalInput(l)}}},updateOriginalInput(e){var t=p(e),a=t.parent().next(".wpforms-smart-tags-widget-original");a.length&&(e=c.getWidgetContent(e),a.val(e),t.hasClass("wpforms-readonly")||a.trigger("input"))},copyWidgetContent(e,t){t=t.val();/\{[^\n\r}]+}/.test(t)&&e.originalEvent.clipboardData&&""!==t&&(e.preventDefault(),e.originalEvent.clipboardData.setData("text/plain",t))},getSmartTagTitle(e){if(!e)return"";e=e.toString().trim();var t=c.getSmartTagFieldTitle(e)||c.getSmartTagWithArgsTitle(e)||wpforms_builder.smart_tags[e];return t?t.replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/&apos;/g,"'"):e},getSmartTagFieldTitle(e){e=e.match(/^(field_id|field_value_id|field_html_id)="(\d+)?(\|[^"]+)?"$/);if(!e||!e.length)return"";var t,a=e[1],r=e[2],e=e[3]?e[3].replace("|",""):"";let n=`[ ${wpforms_builder.smart_tags_edit} ID ]`;return r&&(t=e.length?e.charAt(0).toUpperCase()+e.slice(1):"",e=e.length?" - "+t:"",t=((t=r?p(`#wpforms-field-option-${r}-label`).val():"")||wpforms_builder.smart_tags_unknown_field)+e,n=`#${r}: `+t),wpforms_builder.smart_tags_templates[a].replace("%1$s",n)},getSmartTagWithArgsTitle(e){var t,a,e=e.match(/^(query_var|user_meta|date|entry_date) (key|format)="([^"]+)?"$/);return e&&e.length?(t=e[1],a=e[2]||wpforms_builder.smart_tags_arg,e=e[3]||`[ ${wpforms_builder.smart_tags_edit} ${a} ]`,wpforms_builder.smart_tags_templates[t].replace("%1$s",e)):""},fieldLabelChangeEvent(){c.updateSmartTagsTitles(t.$builder)},updateSmartTagsTitles(e){e.find(".wpforms-smart-tags-widget .tag").each(function(){var e=p(this),t=e.find("i").detach();e.text(c.getSmartTagTitle(e.data("value"))).append(t)})},getWidgetContent(e){if(!e||!e.childNodes)return"";let t="";return e.childNodes.forEach(e=>{e.nodeType===Node.TEXT_NODE?t+=e.nodeValue.replaceAll("​",""):e.nodeType===Node.ELEMENT_NODE&&"BR"===e.nodeName?t+=`
`:e.nodeType===Node.ELEMENT_NODE&&e.classList.contains("tag")&&(e=p(e).data("value"),t+=`{${e}}`)}),t.trim()},initTooltip(e){var e=e.next(".wpforms-show-smart-tags"),t={content:wpforms_builder.smart_tags_button_tooltip,contentAsHTML:!0,interactive:!0,animationDuration:100,delay:[1500,200],side:["top"],maxWidth:270,functionBefore(e,t){if(p(t.origin).hasClass("active"))return!1}};e.tooltipster(t)},smartTagClick(e){let t=p(this);var a,r;t.is(e.target)&&"true"!==t.attr("contenteditable")&&(e.preventDefault(),e=t.data("value"),a=t.find("i").detach(),r=p('<i class="tag-edit-ok fa fa-check-circle"></i>').attr("title",wpforms_builder.smart_tags_edit_ok_button),t.attr("contenteditable",!0).data("restore",e).data("close",a).css("min-width",t.outerWidth()).text(e).after(r).parent().attr("contenteditable",!1),t.data("bind-events")||t.on("blur",c.smartTagBlurEvent).on("keydown",c.smartTagKeyDown).data("bind-events",!0),c.setCaretSmartTagEnd(t),setTimeout(()=>t.focus(),0))},smartTagBlurEvent(){var e=p(this);"true"===e.attr("contenteditable")&&c.smartTagBlur(e)},smartTagBlur(e,t=!1){let a=t?e.data("restore"):e.text();a=a.replace(/[{}]/g,"").trim(),a=wpf.sanitizeHTML(a),e.data("value",a).attr("data-value",a).text(c.getSmartTagTitle(a)).attr("style",null).append(e.data("close")).attr("contenteditable",!1).next(".tag-edit-ok").remove();t=e.parent();t.attr("contenteditable",!0).trigger("input"),m.WPForms?.Admin?.Builder?.UndoRedoInputSmartTags?.recordSmartTagImmediate(t),c.setCaretAfterSmartTag(e)},setCaretAfterSmartTag(t){if(t&&t.length){var a=g.defaultView.getSelection(),r=g.createRange(),n=t[0].parentNode;for(let e=0;e<n.childNodes.length;e++)if(n.childNodes[e]===t[0])return r.setStart(n,e+1),r.collapse(!0),a.removeAllRanges(),void a.addRange(r)}},setCaretSmartTagEnd(e){var t,a;e&&e.length&&(t=g.defaultView.getSelection(),(a=g.createRange()).selectNodeContents(e[0]),a.collapse(!1),t.removeAllRanges(),t.addRange(a))},smartTagKeyDown(e){var t=p(this);switch(e.code){case"Enter":e.preventDefault(),e.stopImmediatePropagation(),c.smartTagBlur(t,!1);break;case"Escape":e.preventDefault(),e.stopImmediatePropagation(),c.smartTagBlur(t,!0)}},initDropdowns(){t.$builder.find(".wpforms-show-smart-tags, .mce-wpforms-smart-tags-mce-button").each(function(){var e=p(this),t=e.data("dropdown-list");t&&t.destroy(),c.getDropdownListInstance(e),e.removeClass("active")})},getDropdownListInstance(r){var e=r.data("dropdown-list");if(!e){var t=r.hasClass("mce-wpforms-smart-tags-mce-button");let a=t?r.closest(".wp-editor-container").find("textarea"):r.closest(".wpforms-smart-tags-widget-container").next(".wpforms-smart-tags-widget-original");var n=a?.attr("id"),n=!!n&&n.includes("wpforms-field-option-"),n=(["location","type","fields","allow-repeated-fields","allowed-smarttags"].forEach(e=>{var t=a.data(e);void 0!==t&&r.attr("data-"+e,t)}),c.getSmartTagsList(r,n));if(!n.length)return r.addClass("disabled"),null;r.removeClass("disabled"),e=c.initDropdownInstance(r,n,t),r.data("dropdown-list",e)}return e},initDropdownInstance(e,t,a=!1){a=c.getDropdownContainer(e,a);return WPForms.Admin.Builder.DropdownList.init({class:"insert-smart-tag-dropdown",title:wpforms_builder.smart_tags_dropdown_title,list:t,container:a,button:e,search:{enabled:!0,searchBy:["wpforms-smart-tags-widget-item"],placeholder:wpforms_builder.search,noResultsText:wpforms_builder.no_results_found},noLeftOffset:!0,itemFormat(e){var t=e.additional?` data-additional="${e.additional}"`:"";let a=`<span class="wpforms-smart-tags-widget-item"
						data-type="${e.type}"${t}>
						${e.text}
				    </span>`;return a=e?.heading?`<span class="heading">${e.text}</span>`:a},onSelect(e,t,a,r,n){0<r.find(".heading").length||c.smartTagInsert(r,t,n)}})},getDropdownContainer(e,t){let a=t?e.closest(".wp-editor-wrap"):e.closest(".wpforms-smart-tags-widget-container");return a=e.closest("td").length?e.parent().parent().parent():a},showSmartTagDropdown(e){p(".insert-smart-tag-dropdown").each(function(){p(this).addClass("closed")});var t,a=c.getDropdownListInstance(e);a&&(t=e.hasClass("active"),e.toggleClass("active",!t),t?a.close():(p(".wpforms-show-smart-tags").not(e).removeClass("active"),a.open()))},getSmartTagsList(e,t){return[...c.getSmartTagsListFieldsElements(e),...c.getSmartTagsListOtherElements(e,t)]},getSmartTagsListFieldsElements(e){var t=e.data("type");if(!["fields","all"].includes(t))return[];var a=c.getSmartTagsFields(e);if(!a)return[{value:0,heading:!0,text:wpforms_builder.fields_unavailable}];var r,n=[];for(r in n.push({value:0,text:wpforms_builder.fields_available,heading:!0}),a)n.push(...c.getSmartTagsListFieldsElement(a[r]));return n},getSmartTagsFields(e){var t=e.data("fields"),e=e.data("allow-repeated-fields"),t=t?t.split(","):void 0;return wpf.getFields(t,!0,e)},getSmartTagsListFieldsElement(a){let r=a.label?wpf.encodeHTMLEntities(wpf.sanitizeHTML(a.label)):wpforms_builder.field+" #"+a.id,n=[{value:a.id,text:r,type:"field"}];var e=a.additional||[];return 1<e.length&&e.forEach(e=>{var t=e.charAt(0).toUpperCase()+e.slice(1).replace(/(\D)(\d)/g,"$1 $2");n.push({value:a.id,text:r+" – "+t,type:"field",additional:e})}),n},getSmartTagsListOtherElements(e,t){var a=e.data("type"),r=[];if("other"===a||"all"===a){var n,i=e.data("allowed-smarttags")?.split(",").filter(Boolean);for(n in r.push({value:0,text:wpforms_builder.other,heading:!0}),wpforms_builder.smart_tags)t&&wpforms_builder.smart_tags_disabled_for_fields.includes(n)||"confirmations"===e.data("location")&&wpforms_builder.smart_tags_disabled_for_confirmations.includes(n)||c.isSmartTagAllowed(n,i)&&r.push({value:n,type:"other",text:wpforms_builder.smart_tags[n]})}return r},isSmartTagAllowed(t,a){if(!a||!a.length)return!0;for(let e=0;e<a.length;e++){var r=String(a[e]).trim();if(r){if(r===t)return!0;r=r.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*");if(new RegExp("^"+r+"$").test(t))return!0}}return!1},smartTagInsert(e,t,a){var r=e.find("span"),e=e.parent().parent().parent().find(".wpforms-smart-tags-widget"),n=r.data("additional")?"|"+r.data("additional"):"",r=" "+("field"===r.data("type")?'{field_id="'+t+n+'"}':"{"+t+"}")+" ";a.$button.hasClass("mce-wpforms-smart-tags-mce-button")?c.insertSmartTagToTinyMCE(a,r):(c.restoreCaretPosition(e[0]),c.insertTagAtCaret(e[0],r)),a.$button.removeClass("active"),a.close()},insertSmartTagToTinyMCE(e,t){"undefined"!=typeof tinyMCE&&(e=e.$button.closest(".wp-editor-container").find("textarea").attr("id"),e=tinyMCE.get(e))&&(e.hasFocus()||e.focus(!0),e.insertContent(t))},saveCaretPosition(e){var t=m.getSelection();t.rangeCount&&(t=t.getRangeAt(0),e.contains(t.startContainer))&&r.set(e,t)},restoreCaretPosition(e){var t=r.get(e),a=e.ownerDocument.defaultView.getSelection();t?(a.removeAllRanges(),a.addRange(t)):((t=g.createRange()).selectNodeContents(e),t.collapse(!1),a.removeAllRanges(),a.addRange(t)),e.focus()},insertTagAtCaret(e,t){var a=g.defaultView.getSelection(),r=a.getRangeAt(0),t=g.createTextNode(t);r.deleteContents(),r.insertNode(t),r.setStartAfter(t),r.setEndAfter(t),a.removeAllRanges(),a.addRange(r),c.renderWidgetContent({target:e},!0),m.WPForms?.Admin?.Builder?.UndoRedoInputSmartTags?.recordSmartTagImmediate(p(e)),e.focus(),this.scrollToCursorPosition(e)},scrollToCursorPosition(s){setTimeout(()=>{var e,t,a,r,n=g.createElement("span"),i=(n.style.display="inline-block",n.style.width="0px",n.style.height="0px",g.getSelection());i.rangeCount&&((i=i.getRangeAt(0).cloneRange()).collapse(!0),i.insertNode(n),i=n.getBoundingClientRect(),e=s.getBoundingClientRect(),r=i.left>=e.left&&i.right<=e.right,t=i.top<e.top,a=i.bottom>e.bottom,!r&&0<i.left&&(r=i.left-e.left-e.width/2,s.scrollLeft+=r),t?s.scrollTop-=e.top-i.top+20:a&&(s.scrollTop+=i.bottom-e.bottom+20),n.parentNode)&&n.parentNode.removeChild(n)},50)},insertLineBreak(){var e,t,a,r=g.getSelection();r.rangeCount&&(e=r.getRangeAt(0),t=g.createElement("br"),e.deleteContents(),e.insertNode(t),c.removeZeroWidthSpaces(t.parentNode),a=g.createTextNode("​"),e.setStartAfter(t),e.insertNode(a),e.setStartAfter(a),e.setEndAfter(a),r.removeAllRanges(),r.addRange(e),this.scrollToCursorPosition(t.parentNode),a=t.closest(".wpforms-smart-tags-widget"))&&this.updateOriginalInput(a)},handleEmailTag(e,t,a,r,n){var i;return/^{[^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*@([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}}$/.test(e)?(i=r.slice(0,a.index),r=r.slice(a.index+e.length),a=g.createTextNode(i),e=g.createTextNode(t),i=g.createTextNode(r),(t=n.parentNode).insertBefore(a,n),t.insertBefore(e,n),t.insertBefore(i,n),t.removeChild(n),{handled:!0,text:r,node:i}):{handled:!1}},fieldAdd(e,t){t=p("#wpforms-field-option-"+t);c.initWidgets(t)},fieldDuplicated(e,t,a,r){r=p("#wpforms-field-option-"+r);c.reinitWidgets(r)},fieldPasted(e,t){t=p("#wpforms-field-option-"+t);c.reinitWidgets(t)},setupOriginalInputObserver(n){if(m.MutationObserver&&n&&n[0]){let a=t.$builder[0],r=n[0];if(a.contains(r)){let e=new MutationObserver(e=>{e.length&&c.reinitWidgets(n.parent())}),t=(e.observe(r,{attributes:!0,attributeFilter:["readonly","disabled"]}),new MutationObserver(()=>{a.contains(r)||(e.disconnect(),t.disconnect())}));t.observe(a,{childList:!0,subtree:!0,attributes:!1})}}},syncWidgetContent(e,t){t.text()!==e.val()&&c.reinitWidgets(t.parent().parent())},removeZeroWidthSpaces(e){for(var t,a=g.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);t=a.nextNode();)t.nodeValue.includes("​")&&(t.nodeValue=t.nodeValue.replaceAll("​",""))}};return c})(document,window,jQuery),WPForms.Admin.Builder.SmartTags.init();