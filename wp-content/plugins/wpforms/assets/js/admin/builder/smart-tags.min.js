var WPForms=window.WPForms||{};WPForms.Admin=WPForms.Admin||{},WPForms.Admin.Builder=WPForms.Admin.Builder||{},WPForms.Admin.Builder.SmartTags=WPForms.Admin.Builder.SmartTags||((g,a,o)=>{let t={},r=new WeakMap,p={init(){o(p.ready)},ready(){p.setup(),p.events()},setup(){t.$builder=o("#wpforms-builder")},events(){t.$builder.on("wpformsBuilderReady",()=>{p.initWidgets(t.$builder)}).on("wpformsBuilderReady",p.initDropdowns).on("connectionsDataLoaded",p.initWidgetsInConnections).on("connectionRendered",p.initWidgetsInConnections).on("wpformsSettingsBlockAdded wpformsSettingsBlockCloned ",p.reinitWidgetInClone).on("wpformsFieldAdd",p.fieldAdd).on("wpformsFieldDuplicated",p.fieldDuplicated).on("change",".wpforms-field-option-row-label input",p.fieldLabelChangeEvent),t.$builder.on("click",".wpforms-show-smart-tags, .mce-wpforms-smart-tags-mce-button",function(){p.showSmartTagDropdown(o(this))}),o(g).on("wpformsFieldUpdate",p.initDropdowns).on("click",".wpforms-smart-tags-widget .tag",p.smartTagClick)},initWidgets(e=t.$builder){e.find(".wpforms-smart-tags-enabled").each(function(){if(!o(this).hasClass("wpforms-smart-tags-widget-original")){let t=o(this),a=t.is("input")?"input":"textarea";var e="wpforms-smart-tags-widget-"+a,n=t.prop("readonly")||t.prop("disabled"),i=n?"wpforms-readonly":"",s=o("<div>",{class:"wpforms-smart-tags-widget-container"});t.before(s);let r=o("<div>",{class:["wpforms-smart-tags-widget",e,i].filter(Boolean).join(" "),contenteditable:n?"false":"true",spellcheck:"false",text:t.val()});s.append(r),s.append('<span class="wpforms-show-smart-tags"><i class="fa fa-tags"></i></span>'),t.addClass("wpforms-smart-tags-widget-original"),p.setupOriginalInputObserver(t),t.on("wpformsSmartTagsInputSync",function(){p.syncWidgetContent(t,r)}),r.on("input",p.renderWidgetContent),r.on("focus blur keyup mouseup",function(){p.saveCaretPosition(r[0])}),r.on("focusout",function(){t.trigger("focusout")}),r.on("copy",function(e){p.copyWidgetContent(e,t)}),r.on("keydown",function(e){"input"==a&&"Enter"===e.key&&e.preventDefault(),"textarea"!=a||"Enter"!==e.key||e.shiftKey||(e.preventDefault(),p.insertLineBreak())}),r.data("pasteHandlerAttached")||(r.on("paste",e=>{var t;e.preventDefault(),r.hasClass("wpforms-readonly")||(t=g.defaultView.getSelection()).rangeCount&&(e=e.originalEvent.clipboardData.getData("text/plain"),(t=t.getRangeAt(0)).deleteContents(),t.insertNode(g.createTextNode(e)),t.collapse(!1),p.renderWidgetContent({target:r[0]},!0,"end"))}),r.data("pasteHandlerAttached",!0)),p.renderWidgetContent({target:r[0]},!0),WPFormsUtils.triggerEvent(r,"wpformsSmartTagWidgetInitialized"),p.initTooltip(r)}})},reinitWidgets(e){e.find(".wpforms-smart-tags-widget-container").each(function(){var e=o(this);e.next(".wpforms-smart-tags-enabled").removeClass("wpforms-smart-tags-widget-original"),e.remove()}),p.initWidgets(e)},reinitWidgetInClone(e,t){p.reinitWidgets(t)},initWidgetsInConnections(e){e=o(e.target);p.initWidgets(e)},renderWidgetContent(e,t=!1,a=""){let d=e.target;if(!d.classList.contains("tag")){d.normalize();e=g.defaultView.getSelection();if(e.rangeCount||t){var r=Array.from(d.childNodes);let l=null;r.forEach(a=>{if(a.nodeType===Node.TEXT_NODE){let t=a.nodeValue;for(var r=/{([^{}]+)}/g;null!==(o=r.exec(t));){var n=wpf.sanitizeHTML(o[1].trim()),i=o[0],s=p.handleEmailTag(i,n,o,t,a);if(s.handled)t=s.text,a=s.node;else{s=p.getSmartTagTitle(n);let e=g.createElement("span");e.classList.add("tag"),e.contentEditable="false",e.setAttribute("data-value",n),e.innerText=s;var n=g.createElement("i"),s=(n.classList.add("fa","fa-times-circle"),n.setAttribute("title",wpforms_builder.smart_tags_delete_button),n.addEventListener("click",()=>{e.remove(),p.updateOriginalInput(d)}),e.appendChild(n),t.slice(0,o.index)),n=t.slice(o.index+i.length),o=g.createTextNode(s),i=g.createTextNode(n),s=a.parentNode;s.insertBefore(o,a),s.insertBefore(e,a),s.insertBefore(i,a),s.removeChild(a),t=n,a=i,l=e,r.lastIndex=0}}}}),l&&!t&&((r=g.createRange()).setStartAfter(l),r.collapse(!0),e.removeAllRanges(),e.addRange(r)),"end"===a&&((t=g.createRange()).selectNodeContents(d),t.collapse(!1),e.removeAllRanges(),e.addRange(t)),p.updateOriginalInput(d)}}},updateOriginalInput(e){var t=o(e),a=t.parent().next(".wpforms-smart-tags-widget-original");a.length&&(e=p.getWidgetContent(e),a.val(e),t.hasClass("wpforms-readonly")||a.trigger("input"))},copyWidgetContent(e,t){t=t.val();/\{[^\n\r}]+}/.test(t)&&e.originalEvent.clipboardData&&""!==t&&(e.preventDefault(),e.originalEvent.clipboardData.setData("text/plain",t))},getSmartTagTitle(e){if(!e)return"";e=e.toString().trim();var t=p.getSmartTagFieldTitle(e)||p.getSmartTagWithArgsTitle(e)||wpforms_builder.smart_tags[e];return t?t.replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/&apos;/g,"'"):e},getSmartTagFieldTitle(e){e=e.match(/^(field_id|field_value_id|field_html_id)="(\d+)?(\|[^"]+)?"$/);if(!e||!e.length)return"";var t,a=e[1],r=e[2],e=e[3]?e[3].replace("|",""):"";let n=`[ ${wpforms_builder.smart_tags_edit} ID ]`;return r&&(t=e.length?e.charAt(0).toUpperCase()+e.slice(1):"",e=e.length?" - "+t:"",t=((t=r?o(`#wpforms-field-option-${r}-label`).val():"")||wpforms_builder.smart_tags_unknown_field)+e,n=`#${r}: `+t),wpforms_builder.smart_tags_templates[a].replace("%1$s",n)},getSmartTagWithArgsTitle(e){var t,a,e=e.match(/^(query_var|user_meta|date|entry_date) (key|format)="([^"]+)?"$/);return e&&e.length?(t=e[1],a=e[2]||wpforms_builder.smart_tags_arg,e=e[3]||`[ ${wpforms_builder.smart_tags_edit} ${a} ]`,wpforms_builder.smart_tags_templates[t].replace("%1$s",e)):""},fieldLabelChangeEvent(){p.updateSmartTagsTitles(t.$builder)},updateSmartTagsTitles(e){e.find(".wpforms-smart-tags-widget .tag").each(function(){var e=o(this),t=e.find("i").detach();e.text(p.getSmartTagTitle(e.data("value"))).append(t)})},getWidgetContent(e){if(!e||!e.childNodes)return"";let t="";return e.childNodes.forEach(e=>{e.nodeType===Node.TEXT_NODE?t+=e.nodeValue.replaceAll("​",""):e.nodeType===Node.ELEMENT_NODE&&"BR"===e.nodeName?t+=`
`:e.nodeType===Node.ELEMENT_NODE&&e.classList.contains("tag")&&(e=o(e).data("value"),t+=`{${e}}`)}),t.trim()},initTooltip(e){var e=e.next(".wpforms-show-smart-tags"),t={content:wpforms_builder.smart_tags_button_tooltip,contentAsHTML:!0,interactive:!0,animationDuration:100,delay:[1500,200],side:["top"],maxWidth:270,functionBefore(e,t){if(o(t.origin).hasClass("active"))return!1}};e.tooltipster(t)},smartTagClick(e){let t=o(this);var a,r;t.is(e.target)&&"true"!==t.attr("contenteditable")&&(e.preventDefault(),e=t.data("value"),a=t.find("i").detach(),r=o('<i class="tag-edit-ok fa fa-check-circle"></i>').attr("title",wpforms_builder.smart_tags_edit_ok_button),t.attr("contenteditable",!0).data("restore",e).data("close",a).css("min-width",t.outerWidth()).text(e).after(r).parent().attr("contenteditable",!1),t.data("bind-events")||t.on("blur",p.smartTagBlurEvent).on("keydown",p.smartTagKeyDown).data("bind-events",!0),p.setCaretSmartTagEnd(t),setTimeout(()=>t.focus(),0))},smartTagBlurEvent(){var e=o(this);"true"===e.attr("contenteditable")&&p.smartTagBlur(e)},smartTagBlur(e,t=!1){let a=t?e.data("restore"):e.text();a=a.replace(/[{}]/g,"").trim(),a=wpf.sanitizeHTML(a),e.data("value",a).attr("data-value",a).text(p.getSmartTagTitle(a)).attr("style",null).append(e.data("close")).attr("contenteditable",!1).next(".tag-edit-ok").remove(),e.parent().attr("contenteditable",!0).trigger("input"),p.setCaretAfterSmartTag(e)},setCaretAfterSmartTag(t){if(t&&t.length){var a=g.defaultView.getSelection(),r=g.createRange(),n=t[0].parentNode;for(let e=0;e<n.childNodes.length;e++)if(n.childNodes[e]===t[0])return r.setStart(n,e+1),r.collapse(!0),a.removeAllRanges(),void a.addRange(r)}},setCaretSmartTagEnd(e){var t,a;e&&e.length&&(t=g.defaultView.getSelection(),(a=g.createRange()).selectNodeContents(e[0]),a.collapse(!1),t.removeAllRanges(),t.addRange(a))},smartTagKeyDown(e){var t=o(this);switch(e.code){case"Enter":e.preventDefault(),e.stopImmediatePropagation(),p.smartTagBlur(t,!1);break;case"Escape":e.preventDefault(),e.stopImmediatePropagation(),p.smartTagBlur(t,!0)}},initDropdowns(){t.$builder.find(".wpforms-show-smart-tags, .mce-wpforms-smart-tags-mce-button").each(function(){var e=o(this),t=e.data("dropdown-list");t&&t.destroy(),p.getDropdownListInstance(e),e.removeClass("active")})},getDropdownListInstance(r){var e=r.data("dropdown-list");if(!e){var t=r.hasClass("mce-wpforms-smart-tags-mce-button");let a=t?r.closest(".wp-editor-container").find("textarea"):r.closest(".wpforms-smart-tags-widget-container").next(".wpforms-smart-tags-widget-original");var n=a?.attr("id"),n=!!n&&n.includes("wpforms-field-option-"),n=(["location","type","fields","allow-repeated-fields","allowed-smarttags"].forEach(e=>{var t=a.data(e);void 0!==t&&r.attr("data-"+e,t)}),p.getSmartTagsList(r,n));if(!n.length)return r.addClass("disabled"),null;r.removeClass("disabled"),e=p.initDropdownInstance(r,n,t),r.data("dropdown-list",e)}return e},initDropdownInstance(e,t,a=!1){a=p.getDropdownContainer(e,a);return WPForms.Admin.Builder.DropdownList.init({class:"insert-smart-tag-dropdown",title:wpforms_builder.smart_tags_dropdown_title,list:t,container:a,button:e,search:{enabled:!0,searchBy:["wpforms-smart-tags-widget-item"],placeholder:wpforms_builder.search,noResultsText:wpforms_builder.no_results_found},noLeftOffset:!0,itemFormat(e){var t=e.additional?` data-additional="${e.additional}"`:"";let a=`<span class="wpforms-smart-tags-widget-item"
						data-type="${e.type}"${t}>
						${e.text}
				    </span>`;return a=e?.heading?`<span class="heading">${e.text}</span>`:a},onSelect(e,t,a,r,n){0<r.find(".heading").length||p.smartTagInsert(r,t,n)}})},getDropdownContainer(e,t){let a=t?e.closest(".wp-editor-wrap"):e.closest(".wpforms-smart-tags-widget-container");return a=e.closest("td").length?e.parent().parent().parent():a},showSmartTagDropdown(e){o(".insert-smart-tag-dropdown").each(function(){o(this).addClass("closed")});var t,a=p.getDropdownListInstance(e);a&&(t=e.hasClass("active"),e.toggleClass("active",!t),t?a.close():(o(".wpforms-show-smart-tags").not(e).removeClass("active"),a.open()))},getSmartTagsList(e,t){return[...p.getSmartTagsListFieldsElements(e),...p.getSmartTagsListOtherElements(e,t)]},getSmartTagsListFieldsElements(e){var t=e.data("type");if(!["fields","all"].includes(t))return[];var a=p.getSmartTagsFields(e);if(!a)return[{value:0,heading:!0,text:wpforms_builder.fields_unavailable}];var r,n=[];for(r in n.push({value:0,text:wpforms_builder.fields_available,heading:!0}),a)n.push(...p.getSmartTagsListFieldsElement(a[r]));return n},getSmartTagsFields(e){var t=e.data("fields"),e=e.data("allow-repeated-fields"),t=t?t.split(","):void 0;return wpf.getFields(t,!0,e)},getSmartTagsListFieldsElement(a){let r=a.label?wpf.encodeHTMLEntities(wpf.sanitizeHTML(a.label)):wpforms_builder.field+" #"+a.id,n=[{value:a.id,text:r,type:"field"}];var e=a.additional||[];return 1<e.length&&e.forEach(e=>{var t=e.charAt(0).toUpperCase()+e.slice(1).replace(/(\D)(\d)/g,"$1 $2");n.push({value:a.id,text:r+" – "+t,type:"field",additional:e})}),n},getSmartTagsListOtherElements(e,t){var a=e.data("type"),r=[];if("other"===a||"all"===a){var n,i=e.data("allowed-smarttags")?.split(",").filter(Boolean);for(n in r.push({value:0,text:wpforms_builder.other,heading:!0}),wpforms_builder.smart_tags)t&&wpforms_builder.smart_tags_disabled_for_fields.includes(n)||"confirmations"===e.data("location")&&wpforms_builder.smart_tags_disabled_for_confirmations.includes(n)||p.isSmartTagAllowed(n,i)&&r.push({value:n,type:"other",text:wpforms_builder.smart_tags[n]})}return r},isSmartTagAllowed(t,a){if(!a||!a.length)return!0;for(let e=0;e<a.length;e++){var r=String(a[e]).trim();if(r){if(r===t)return!0;r=r.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*");if(new RegExp("^"+r+"$").test(t))return!0}}return!1},smartTagInsert(e,t,a){var r=e.find("span"),e=e.parent().parent().parent().find(".wpforms-smart-tags-widget"),n=r.data("additional")?"|"+r.data("additional"):"",r=" "+("field"===r.data("type")?'{field_id="'+t+n+'"}':"{"+t+"}")+" ";a.$button.hasClass("mce-wpforms-smart-tags-mce-button")?p.insertSmartTagToTinyMCE(a,r):(p.restoreCaretPosition(e[0]),p.insertTagAtCaret(e[0],r)),a.$button.removeClass("active"),a.close()},insertSmartTagToTinyMCE(e,t){"undefined"!=typeof tinyMCE&&(e=e.$button.closest(".wp-editor-container").find("textarea").attr("id"),e=tinyMCE.get(e))&&(e.hasFocus()||e.focus(!0),e.insertContent(t))},saveCaretPosition(e){var t=a.getSelection();t.rangeCount&&(t=t.getRangeAt(0),e.contains(t.startContainer))&&r.set(e,t)},restoreCaretPosition(e){var t=r.get(e),a=e.ownerDocument.defaultView.getSelection();t?(a.removeAllRanges(),a.addRange(t)):((t=g.createRange()).selectNodeContents(e),t.collapse(!1),a.removeAllRanges(),a.addRange(t)),e.focus()},insertTagAtCaret(e,t){var a=g.defaultView.getSelection(),r=a.getRangeAt(0),t=g.createTextNode(t);r.deleteContents(),r.insertNode(t),r.setStartAfter(t),r.setEndAfter(t),a.removeAllRanges(),a.addRange(r),p.renderWidgetContent({target:e},!0),e.focus(),this.scrollToCursorPosition(e)},scrollToCursorPosition(s){setTimeout(()=>{var e,t,a,r,n=g.createElement("span"),i=(n.style.display="inline-block",n.style.width="0px",n.style.height="0px",g.getSelection());i.rangeCount&&((i=i.getRangeAt(0).cloneRange()).collapse(!0),i.insertNode(n),i=n.getBoundingClientRect(),e=s.getBoundingClientRect(),r=i.left>=e.left&&i.right<=e.right,t=i.top<e.top,a=i.bottom>e.bottom,!r&&0<i.left&&(r=i.left-e.left-e.width/2,s.scrollLeft+=r),t?s.scrollTop-=e.top-i.top+20:a&&(s.scrollTop+=i.bottom-e.bottom+20),n.parentNode)&&n.parentNode.removeChild(n)},50)},insertLineBreak(){var e,t,a,r=g.getSelection();r.rangeCount&&(e=r.getRangeAt(0),t=g.createElement("br"),e.deleteContents(),e.insertNode(t),p.removeZeroWidthSpaces(t.parentNode),a=g.createTextNode("​"),e.setStartAfter(t),e.insertNode(a),e.setStartAfter(a),e.setEndAfter(a),r.removeAllRanges(),r.addRange(e),this.scrollToCursorPosition(t.parentNode),a=t.closest(".wpforms-smart-tags-widget"))&&this.updateOriginalInput(a)},handleEmailTag(e,t,a,r,n){var i;return/^{[^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*@([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}}$/.test(e)?(i=r.slice(0,a.index),r=r.slice(a.index+e.length),a=g.createTextNode(i),e=g.createTextNode(t),i=g.createTextNode(r),(t=n.parentNode).insertBefore(a,n),t.insertBefore(e,n),t.insertBefore(i,n),t.removeChild(n),{handled:!0,text:r,node:i}):{handled:!1}},fieldAdd(e,t){t=o("#wpforms-field-option-"+t);p.initWidgets(t)},fieldDuplicated(e,t,a,r){r=o("#wpforms-field-option-"+r);p.reinitWidgets(r)},setupOriginalInputObserver(n){if(a.MutationObserver&&n&&n[0]){let a=t.$builder[0],r=n[0];if(a.contains(r)){let e=new MutationObserver(e=>{e.length&&p.reinitWidgets(n.parent())}),t=(e.observe(r,{attributes:!0,attributeFilter:["readonly","disabled"]}),new MutationObserver(()=>{a.contains(r)||(e.disconnect(),t.disconnect())}));t.observe(a,{childList:!0,subtree:!0,attributes:!1})}}},syncWidgetContent(e,t){t.text()!==e.val()&&p.reinitWidgets(t.parent().parent())},removeZeroWidthSpaces(e){for(var t,a=g.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);t=a.nextNode();)t.nodeValue.includes("​")&&(t.nodeValue=t.nodeValue.replaceAll("​",""))}};return p})(document,window,jQuery),WPForms.Admin.Builder.SmartTags.init();