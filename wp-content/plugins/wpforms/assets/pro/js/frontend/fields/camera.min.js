var WPForms=window.WPForms||{};WPForms.Camera=WPForms.Camera||((n,c,s)=>{let d=wpforms_camera_frontend.strings,l={stream:null,currentFacingMode:"user",init(){s(l.ready)},ready(){l.events()},events(){n.querySelectorAll(".wpforms-container").forEach(function(e){l.addCameraClickHandler(e)}),s(n).on("click",".wpforms-camera-link, .wpforms-camera-button",l.openModal),s(n).on("click",".wpforms-camera-capture",l.capture),s(n).on("click",".wpforms-camera-remove-file",l.clearSelectedFile),s(n).on("click",".wpforms-camera-flip",l.flipCamera)},addCameraClickHandler(e){e.addEventListener("click",function(e){if(e.target.classList.contains("wpforms-camera")||e.target.closest(".wpforms-camera"))return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),l.openModal(e),!1},!0)},openModal(e){e.preventDefault(),e.target.blur();var r=c.scrollY||n.documentElement.scrollTop,r=(n.body.style.top=`-${r}px`,s(e.target.closest(".wpforms-field"))),e=r.data("field-id"),r=r.closest(".wpforms-form").data("formid");let a=s(`#wpforms-camera-modal-${r}-`+e);var o,t=a.find(".wpforms-camera-video-countdown");t.length&&(o=parseInt(t.data("time-limit"),10)||30,t.find("span").text(l.formatTime(o))),s("body").addClass("wpforms-camera-modal-open"),l.isPhone()&&a.find(".wpforms-camera-flip").addClass("wpforms-camera-flip-active"),a.css("display","flex"),l.initCamera(r,e),a.find(".wpforms-camera-modal-close").off("click").on("click",function(){l.closeModal(a)}),l.addKeyboardListener(a)},closeModal(e){l.stopCamera(),l.removeKeyboardListener(e),s("body").removeClass("wpforms-camera-modal-open");var r=parseInt(n.body.style.top||"0",10),r=(n.body.style.top="",c.scrollTo(0,Math.abs(r)),e.css("display","none"),e.find(".wpforms-camera-captured-photo").remove(),e.find(".wpforms-camera-captured-video").remove(),e.find(".wpforms-camera-modal-buttons").hide(),e.find(".wpforms-camera-stop").hide(),e.find("cropper-canvas").remove(),e.removeData("cropper"),e.removeData("cropped-blob"),e.find("video").show(),e.find(".wpforms-camera-modal-actions").css("display","flex"),e.find(".wpforms-camera-capture").show(),e.data("form-id")),a=e.data("field-id");r&&a&&s(n).trigger("wpforms-camera-modal-closed",{formId:r,fieldId:a,modalOverlay:e})},addKeyboardListener(r){function e(e){32===e.keyCode&&"flex"===r.css("display")&&(e.preventDefault(),(e=r.find(".wpforms-camera-stop")).is(":visible")?e.trigger("click"):(e=r.find(".wpforms-camera-capture")).is(":visible")&&!e.prop("disabled")&&e.trigger("click"))}r.data("keyboard-handler",e),s(n).on("keydown.wpforms-camera",e)},removeKeyboardListener(e){var r=e.data("keyboard-handler");r&&(s(n).off("keydown.wpforms-camera",r),e.removeData("keyboard-handler"))},initCamera(e,r){var a=s(`#wpforms-camera-video-${e}-`+r);let o=s(`#wpforms-camera-modal-${e}-${r} .wpforms-camera-preview`),t=s(`#wpforms-camera-modal-${e}-${r} .wpforms-camera-error`);e=s(`#wpforms-camera-modal-${e}-`+r);let c=a.get(0),i=e.find(".wpforms-camera-capture"),n=e.hasClass("wpforms-camera-format-video");o.css("display","flex"),t.hide(),l.stopCamera();r={audio:n,video:{facingMode:l.currentFacingMode,height:{ideal:960,max:1280},frameRate:{ideal:24,max:30}}};navigator.mediaDevices.getUserMedia(r).then(function(e){l.stream=e,c.srcObject=e,i.removeAttr("disabled")}).catch(function(){var e=n?d.camera_video_access_error:d.camera_access_error;o.hide(),t.text(e).show()})},isPhone(){var e,r,a,o,t;return void 0!==navigator.userAgentData?.mobile?navigator.userAgentData.mobile:(e="MacIntel"===navigator.platform&&1<navigator.maxTouchPoints,r=navigator.userAgent.toLowerCase(),r=/(iphone|ipod|android.*mobile|windows phone|bb10|opera mini|mobile safari)/.test(r),a=matchMedia("(pointer: coarse)").matches,o=matchMedia("(hover: none)").matches,t="ontouchstart"in c||0<navigator.maxTouchPoints,!e&&r||(a||o)&&t)},stopCamera(){s(".wpforms-camera-modal-overlay").each(function(){var e=s(this),r=e.data("media-recorder"),r=(r&&"recording"===r.state&&r.stop(),e.data("countdown-timer"));r&&clearInterval(r)}),l.stream&&(s.each(l.stream.getTracks(),function(e,r){r.stop()}),l.stream=null)},flipCamera(e){var r;l.isPhone()&&(e&&e.preventDefault(),(e=s(e.target).closest(".wpforms-camera-modal-overlay")).length)&&(r=e.data("form-id"),e=e.data("field-id"),l.currentFacingMode="user"===l.currentFacingMode?"environment":"user",l.initCamera(r,e))},capture(e){e.preventDefault();var e=s(e.currentTarget),r=e.closest(".wpforms-camera-modal-overlay"),a=r.data("form-id"),r=r.data("field-id");l.captureAnimation(e,a,r)},captureAnimation(e,r,a){let o=e.parent().find(".wpforms-camera-countdown"),t=o.find("span"),c=o.closest(".wpforms-camera-modal-overlay").hasClass("wpforms-camera-format-photo")?"photo":"video",i=(e.closest(".wpforms-camera-modal-overlay").find(".wpforms-camera-flip").removeClass("wpforms-camera-flip-active"),e.hide(),o.css("display","flex"),setTimeout(function(){o.addClass("animate")},50),wpforms_camera_frontend.wait_time);var n=0<i?1e3:0;function d(){0<--i?(t.text(i),setTimeout(d,1e3)):(o.removeClass("animate").hide(),t.text(wpforms_camera_frontend.wait_time.toString()),"photo"==c?(e.css("display","flex"),l.takePhoto(r,a)):l.recordVideo(r,a))}setTimeout(d,n)},takePhoto(e,r){var a,o,t,c,i,n,d;l.stream&&(a=s(`#wpforms-camera-modal-${e}-`+r),o=s(`#wpforms-camera-video-${e}-`+r),c=s(`#wpforms-camera-canvas-${e}-`+r),t=a.find(".wpforms-camera-preview"),n=o.get(0),c=c.get(0),d=n.videoWidth,i=n.videoHeight,c.width=d,c.height=i,c.getContext("2d").drawImage(n,0,0,d,i),o.hide(),n=s("<img>",{class:"wpforms-camera-captured-photo",src:c.toDataURL("image/jpeg",.92)}),t.append(n),a.find(".wpforms-camera-modal-actions").hide(),(d=a.find(".wpforms-camera-modal-buttons")).show(),this.addPhotoHandlers(d,c,a,e,r,t,o))},addPhotoHandlers(r,a,o,t,c,i,n){r.find(".wpforms-camera-accept").off("click").on("click",function(e){e.preventDefault();e=o.data("cropped-blob");e?(l.closeModal(o),l.attachFile(t,c,e),o.css("display","none")):a.toBlob(function(e){e&&(l.closeModal(o),l.attachFile(t,c,e),o.css("display","none"))},"image/jpeg",.92)}),r.find(".wpforms-camera-cancel").off("click").on("click",function(e){e.preventDefault(),i.find(".wpforms-camera-captured-photo").remove(),n.show(),o.find(".wpforms-camera-modal-actions").css("display","flex"),r.hide(),o.removeData("cropped-blob"),o.find("cropper-canvas").remove(),r.find(".wpforms-camera-accept-crop").hide(),r.find(".wpforms-camera-crop-cancel").hide(),r.find(".wpforms-camera-crop").show(),r.find(".wpforms-camera-accept").show(),o.find(".wpforms-camera-flip").addClass("wpforms-camera-flip-active")}),r.off("click",".wpforms-camera-crop").on("click",".wpforms-camera-crop",function(e){e.preventDefault();e=l.initCropper(i);o.data("cropper",e),s(this).hide(),r.find(".wpforms-camera-accept").hide(),r.find(".wpforms-camera-accept-crop").show(),r.find(".wpforms-camera-crop-cancel").show()}),r.off("click",".wpforms-camera-crop-cancel").on("click",".wpforms-camera-crop-cancel",function(e){e.preventDefault(),l.cancelCrop(o,r)}),r.off("click",".wpforms-camera-accept-crop").on("click",".wpforms-camera-accept-crop",function(e){e.preventDefault(),l.acceptCrop(o,r)})},acceptCrop(a,e){var r=a.data("cropper"),o=r.getCropperSelection();let t=a.find(".wpforms-camera-captured-photo");r=l.createManualCroppedCanvas(r,o,t);r?(r.toBlob(function(e){var r;e&&(r=URL.createObjectURL(e),t.attr("src",r),a.data("cropped-blob",e))},"image/jpeg",.92),a.find("cropper-canvas").remove(),a.removeData("cropper"),a.find(".wpforms-camera-captured-photo").show(),e.find(".wpforms-camera-crop-cancel").hide(),e.find(".wpforms-camera-accept-crop").hide(),e.find(".wpforms-camera-crop").show(),e.find(".wpforms-camera-accept").show()):l.cancelCrop(a,e)},cancelCrop(e,r){e.data("cropper")&&(e.find("cropper-canvas").remove(),e.removeData("cropper"),e.find(".wpforms-camera-captured-photo").show()),e.removeData("cropped-blob"),r.find(".wpforms-camera-crop-cancel").hide(),r.find(".wpforms-camera-accept-crop").hide(),r.find(".wpforms-camera-accept").show(),r.find(".wpforms-camera-crop").show()},createManualCroppedCanvas(e,r,a){var o,t,c,i,a=a[0];return!a||!a.complete||(e=e.getCropperCanvas().getBoundingClientRect(),o=((r=r.getBoundingClientRect()).left-e.left)/e.width,t=(r.top-e.top)/e.height,c=r.width/e.width,r=r.height/e.height,e=a.naturalWidth||a.width,i=a.naturalHeight||a.height,o=Math.max(0,Math.floor(o*e)),t=Math.max(0,Math.floor(t*i)),c=Math.min(e-o,Math.floor(c*e)),e=Math.min(i-t,Math.floor(r*i)),c<=0)||e<=0?null:((r=n.createElement("canvas")).width=c,r.height=e,(i=r.getContext("2d")).imageSmoothingEnabled=!0,i.imageSmoothingQuality="high",i.drawImage(a,o,t,c,e,0,0,c,e),r)},initCropper(e){var r=c.Cropper&&c.Cropper.default||c.Cropper,a=e[0],r=new r(e.find(".wpforms-camera-captured-photo")[0],{container:a,template:l.getCropperTemplate()}),e=r.getCropperCanvas(),a=r.getCropperSelection();return n.querySelector("cropper-grid").$addStyles(`
					:host>span+span {
						border-top: 1px solid #fff;
					}
					:host>span>span+span {
						border-left: 1px solid #fff;
					}
					`),e&&a&&l.limitCropperBoundaries(e,a),r},getCropperTemplate(){return`
				<cropper-canvas background>
					<cropper-image></cropper-image>
					<cropper-shade theme-color="rgba(0, 0, 0, 0.75)"></cropper-shade>
					<cropper-handle action="select" plain></cropper-handle>
					<cropper-selection initial-coverage="0.7" movable resizable>
						<cropper-grid role="grid" theme-color="#fff" bordered covered></cropper-grid>
						<cropper-handle action="move" theme-color="transparent"></cropper-handle>
						<cropper-handle theme-color="#fff" action="n-resize"></cropper-handle>
						<cropper-handle theme-color="#fff" action="e-resize"></cropper-handle>
						<cropper-handle theme-color="#fff" action="s-resize"></cropper-handle>
						<cropper-handle theme-color="#fff" action="w-resize"></cropper-handle>
						<cropper-handle theme-color="#fff" action="ne-resize"></cropper-handle>
						<cropper-handle theme-color="#fff" action="nw-resize"></cropper-handle>
						<cropper-handle theme-color="#fff" action="se-resize"></cropper-handle>
						<cropper-handle theme-color="#fff" action="sw-resize"></cropper-handle>
					</cropper-selection>
				</cropper-canvas>
				`},limitCropperBoundaries(n,e){e.addEventListener("change",e=>{var{x:r,y:a,width:o,height:t}=e.detail,{width:c,height:i}=n.getBoundingClientRect();0<=r&&0<=a&&r+o<=c&&a+t<=i||e.preventDefault()})},isMediaRecorderSupported(){return"undefined"!=typeof MediaRecorder},handleUnsupportedMediaRecorder(e,r){e=s(`#wpforms-camera-modal-${e}-`+r),r=e.find(".wpforms-camera-preview"),e=e.find(".wpforms-camera-error");r.hide(),e.text(d.video_recording_error).show()},getSupportedVideoType(){let e={mimeType:"video/webm;codecs=vp9,opus",extension:"webm",videoBitsPerSecond:25e5};var r,a=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);if(a)MediaRecorder.isTypeSupported("video/mp4")&&(e={mimeType:"video/mp4",extension:"mp4",videoBitsPerSecond:25e5});else for(r of["video/webm;codecs=vp9,opus","video/webm;codecs=vp8,opus","video/webm"])if(MediaRecorder.isTypeSupported(r)){e.mimeType=r;break}return e},createMediaRecorder(e,r,a,o){try{return new MediaRecorder(l.stream,{mimeType:e.mimeType,videoBitsPerSecond:e.videoBitsPerSecond})}catch(e){try{return new MediaRecorder(l.stream)}catch(e){return r.hide(),a.text(d.video_recording_error).show(),o.hide(),null}}},setupRecordingTimer(e,r,a,o,t){let c=e,i=(r.text(l.formatTime(c)),setInterval(function(){c--,r.text(l.formatTime(c)),c<=0&&(clearInterval(i),"recording"===a.state&&a.stop(),o.hide())},1e3));return t.data("countdown-timer",i),i},setupStopButton(r,a,o,t,c){r.off("click").on("click",function(e){e.preventDefault(),clearInterval(a.data("countdown-timer")),r.hide(),"recording"===o.state&&o.stop(),c.text(l.formatTime(t))})},setupCancelVideoButton(r){r.find(".wpforms-camera-cancel-video").show().off("click").on("click",function(e){e.preventDefault(),l.closeModal(r)})},handleRecordingComplete(e,r,a,o,t,c,i){var n=URL.createObjectURL(e),d=s(`#wpforms-camera-video-${a}-`+o),p=(d.hide(),this.createRecordedVideoElement(n));i.append(p),this.setupRecordingAcceptUI(c,e,r,n,a,o,t,d,i)},createRecordedVideoElement(e){return s("<video>",{class:"wpforms-camera-captured-video",src:e,controls:!0,autoplay:!0,muted:!1,playsinline:!0})},setupRecordingAcceptUI(r,a,o,t,c,i,n,d,p){r.find(".wpforms-camera-modal-actions").hide();let m=r.find(".wpforms-camera-modal-buttons");m.show(),m.find(".wpforms-camera-accept").off("click").on("click",function(e){e.preventDefault(),l.closeModal(r);e=n.extension||"webm",e=`camera-video-${Date.now()}.`+e,e=new File([a],e,{type:o});l.attachFile(c,i,e),r.css("display","none")}),m.find(".wpforms-camera-cancel").off("click").on("click",function(e){e.preventDefault(),p.find(".wpforms-camera-captured-video").remove(),URL.revokeObjectURL(t),d.show(),r.find(".wpforms-camera-capture").css("display","flex"),r.find(".wpforms-camera-modal-actions").css("display","flex"),r.find(".wpforms-camera-flip").addClass("wpforms-camera-flip-active"),m.hide()})},recordVideo(n,d){if(l.stream)if(l.isMediaRecorderSupported()){let o=s(`#wpforms-camera-modal-${n}-`+d);var e=o.find(".wpforms-camera-stop"),r=o.find(".wpforms-camera-video-countdown");let t=o.find(".wpforms-camera-preview");var p=o.find(".wpforms-camera-error"),m=parseInt(r.data("time-limit"),10)||30;e.show();let c=l.getSupportedVideoType(),i=l.createMediaRecorder(c,t,p,e);if(i){let a=[];i.ondataavailable=function(e){e.data&&0<e.data.size&&a.push(e.data)},i.onstop=function(){var e=i.mimeType||c.mimeType||"video/webm",r=new Blob(a,{type:e});l.handleRecordingComplete(r,e,n,d,c,o,t)},i.start(1e3),o.data("media-recorder",i);p=r.find("span");l.setupRecordingTimer(m,p,i,e,o),l.setupStopButton(e,o,i,m,p),l.setupCancelVideoButton(o)}}else l.handleUnsupportedMediaRecorder(n,d)},attachFile(e,r,a){let o,t;t=a.type.startsWith("video/")?(i=a.type.includes("mp4")?"mp4":"webm",o=`camera-video-${Date.now()}.`+i,a.type||("mp4"==i?"video/mp4":"video/webm")):(o=`camera-photo-${Date.now()}.jpg`,"image/jpeg");var c,i=new File([a],o,{type:t}),a=s(`.wpforms-uploader[data-form-id="${e}"][data-field-id="${r}"]`);0<a.length?(c=a[0])&&c.dropzone&&(c.dropzone.addFile(i),(a=a.parents(".wpforms-field-camera").find('input[name="'+c.dataset.inputName+'"]')).length)&&l.setCameraFieldState(a,i):(c=s(`#wpforms-${e}-field_`+r)).length&&((a=new DataTransfer).items.add(i),c[0].files=a.files,c.trigger("change"),l.setCameraFieldState(c,i))},setCameraFieldState(e,r){if(e.length&&n.contains(e[0])){var a=e.closest(".wpforms-field-camera");if(a.length){r=r?.name??"";if(!r)return;var o=a.find(".wpforms-camera-link, .wpforms-camera-button");if(!o.length)return;o.hide(),a.find(".wpforms-camera-selected-file").addClass("wpforms-camera-selected-file-active").find("span").text(r),a.removeClass("wpforms-has-error"),e.removeClass("wpforms-error"),a.find(".wpforms-error").remove(),l.checkAndHideGeneralFormError(a)}o=e.closest(".wpforms-field-file-upload");o.length&&(o.removeClass("wpforms-has-error"),o.find(".wpforms-error:not(input)").remove(),e.removeClass("wpforms-error"),e.show().css("display","block"),e.data("validator")&&e.valid(),l.checkAndHideGeneralFormError(o))}},clearSelectedFile(e){e.preventDefault();var r,a,e=s(e.currentTarget).closest(".wpforms-field-camera");e.length&&(r=e.find('input[type="file"]')[0])&&(a=e.find(".wpforms-camera-selected-file"),e=e.find(".wpforms-camera-link, .wpforms-camera-button"),r.value="",a.removeClass("wpforms-camera-selected-file-active"),e.show())},formatTime(e){return Math.floor(e/60)+":"+(e%60).toString().padStart(2,"0")},checkAndHideGeneralFormError(e){e=e.closest("form");!e.length||0<e.find(".wpforms-has-error, .wpforms-error").length||e.find(".wpforms-error-container").remove()}};return l})(document,window,jQuery),WPForms.Camera.init();